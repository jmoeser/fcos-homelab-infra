# desired-state.yaml
# Single source of truth for this Raspberry Pi's configuration.

# --- apt packages ---
packages:
  install:
    # - htop
    # - tmux
    - git
    - python3
    - python3-yaml
    # - strace
    # Required for B2 backups
    - rclone
    # Required for firewall persistence across reboots
    - iptables-persistent
  remove: []

# --- SOPS-encrypted secrets ---
# Files in secrets/ are encrypted with age via SOPS.
# The reconciler decrypts them using the age key at /etc/homelab-gitops/age-key.txt
# and deploys the plaintext to the target path with restricted permissions.
secrets:
  - source: postgres.env
    target: /etc/homelab-gitops/postgres.env
    mode: "0600"

  - source: tailscale-firefly.env
    target: /etc/homelab-gitops/tailscale-firefly.env
    mode: "0600"

  - source: tailscale-glow-worm.env
    target: /etc/homelab-gitops/tailscale-glow-worm.env
    mode: "0600"

  - source: tailscale-openclaw.env
    target: /etc/homelab-gitops/tailscale-openclaw.env
    mode: "0600"

  - source: firefly.env
    target: /etc/homelab-gitops/firefly.env
    mode: "0600"

  - source: glow-worm.env
    target: /etc/homelab-gitops/glow-worm.env
    mode: "0600"

  - source: openclaw.env
    target: /home/openclaw/.config/homelab-gitops/openclaw.env
    owner: openclaw
    mode: "0600"

  - source: rclone.conf
    target: /etc/homelab-gitops/rclone.conf
    mode: "0600"

  - source: tailscale-ollama.env
    target: /etc/homelab-gitops/tailscale-ollama.env
    mode: "0600"

# --- Podman Quadlet containers ---
quadlet:
  source_dir: quadlet
  target_dir: /etc/containers/systemd
  units:
    # Networks
    - app-network.network
    # Volumes
    - postgres-data.volume
    - ts-firefly-state.volume
    - ts-glow-worm-state.volume
    - ts-openclaw-state.volume
    - ts-ollama-state.volume
    - ollama-models.volume
    - caddy-data.volume
    - caddy-config.volume
    # Database
    - postgres.container
    # Tailscale sidecars (must start before their paired app)
    - ts-firefly.container
    - ts-glow-worm.container
    - ts-openclaw.container
    - ts-ollama.container
    # Python applications (share TS sidecar network namespace)
    - firefly.container
    - glow-worm.container
    # Ollama LLM server (shares ts-ollama network namespace)
    - ollama.container
    # LAN reverse proxy
    - caddy.container

# --- User-level Podman Quadlet containers (rootless) ---
user_quadlets:
  - user: openclaw
    source_dir: quadlet/openclaw
    target_dir: /home/openclaw/.config/containers/systemd
    units:
      - openclaw-network.network
      - openclaw-config.volume
      - openclaw.container

# --- Systemd units ---
systemd:
  source_dir: systemd
  target_dir: /etc/systemd/system
  units:
    - name: pg-backup.service
      enabled: false
    - name: pg-backup.timer
      enabled: true

# --- Config files (non-secret, committed in plaintext) ---
files:
  - source: etc/caddy/Caddyfile
    target: /etc/caddy/Caddyfile
    mode: "0644"
    reload_cmd: podman exec caddy caddy reload --config /etc/caddy/Caddyfile 2>/dev/null || true

  - source: etc/homelab-gitops/pg-init/init-databases.sh
    target: /etc/homelab-gitops/pg-init/init-databases.sh
    mode: "0755"

  - source: etc/homelab-gitops/age-recipients.txt
    target: /etc/homelab-gitops/age-recipients.txt
    mode: "0644"

  - source: etc/homelab-gitops/ts-serve/firefly-serve.json
    target: /etc/homelab-gitops/ts-serve/firefly-serve.json
    mode: "0644"

  - source: etc/homelab-gitops/ts-serve/glow-worm-serve.json
    target: /etc/homelab-gitops/ts-serve/glow-worm-serve.json
    mode: "0644"

  - source: etc/homelab-gitops/ts-serve/openclaw-serve.json
    target: /etc/homelab-gitops/ts-serve/openclaw-serve.json
    mode: "0644"

  - source: etc/homelab-gitops/ts-serve/ollama-serve.json
    target: /etc/homelab-gitops/ts-serve/ollama-serve.json
    mode: "0644"

  - source: etc/homelab-gitops/openclaw/openclaw.json
    target: /home/openclaw/.config/homelab-gitops/openclaw/openclaw.json
    owner: openclaw
    mode: "0644"

  - source: etc/sysctl.d/99-custom.conf
    target: /etc/sysctl.d/99-custom.conf
    mode: "0644"
    reload_cmd: sysctl --system

  - source: etc/ssh/sshd_config.d/99-hardening.conf
    target: /etc/ssh/sshd_config.d/99-hardening.conf
    mode: "0600"
    reload_cmd: systemctl reload sshd

# --- Firewall rules ---
# Managed via iptables custom chains (HOMELAB-INPUT, HOMELAB-FORWARD).
# Rules persist across reboots via iptables-persistent / netfilter-persistent.
firewall:
  open_ports:
    - port: 443/tcp
    - port: 80/tcp
    - port: 22/tcp
    # Note: OpenClaw is now only reachable via Tailscale â€” no LAN port needed
  forward_allow:
    # ACCEPT rules evaluated before the REJECT rules below (order matters).
    - -s 10.89.2.0/24 -d 10.89.1.0/24 -p tcp --dport 8000 -j ACCEPT   # glow-worm MCP server
    - -s 10.89.2.0/24 -d 10.89.1.3 -p tcp --dport 11434 -j ACCEPT      # ollama API
  forward_rules:
    # Prevent openclaw-network (10.89.2.0/24) from reaching local/internal networks.
    # Allows outbound internet access only. Applied to the HOMELAB-FORWARD chain.
    # NOTE: Requires rootless Podman to use netavark bridge (not slirp4netns) to take effect.
    # Verify with: iptables -L HOMELAB-FORWARD -n -v
    - -s 10.89.2.0/24 -d 192.168.0.0/16 -j REJECT    # home LAN
    - -s 10.89.2.0/24 -d 10.89.1.0/24 -j REJECT       # app-network (postgres, other services)
    - -s 10.89.2.0/24 -d 172.16.0.0/12 -j REJECT      # RFC1918 172.16-31.x
    - -s 10.89.2.0/24 -d 100.64.0.0/10 -j REJECT      # Tailscale CGNAT (prevent reaching tailnet peers)

# --- Kernel parameters ---
sysctl:
  net.core.somaxconn: 4096
  vm.swappiness: 10

# --- Reconciler settings ---
reconciler:
  interval_minutes: 5
  log_identifier: homelab-reconciler
  auto_reboot: false
  max_drift_minutes: 30
  sops_version: "3.11.0"
